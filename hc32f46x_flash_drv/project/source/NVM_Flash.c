/*
 *          ___                        ___                   _____          ___
 *         /__/\          ___         /__/\                 /  /::\        /  /\          ___
 *         \  \:\        /__/\       |  |::\               /  /:/\:\      /  /::\        /__/\
 *          \  \:\       \  \:\      |  |:|:\             /  /:/  \:\    /  /:/\:\       \  \:\
 *      _____\__\:\       \  \:\   __|__|:|\:\           /__/:/ \__\:|  /  /:/~/:/        \  \:\
 *     /__/::::::::\  ___  \__\:\ /__/::::| \:\          \  \:\ /  /:/ /__/:/ /:/___  ___  \__\:\
 *     \  \:\~~\~~\/ /__/\ |  |:| \  \:\~~\__\/           \  \:\  /:/  \  \:\/:::::/ /__/\ |  |:|
 *      \  \:\  ~~~  \  \:\|  |:|  \  \:\                  \  \:\/:/    \  \::/~~~~  \  \:\|  |:|
 *       \  \:\       \  \:\__|:|   \  \:\                  \  \::/      \  \:\       \  \:\__|:|
 *        \  \:\       \__\::::/     \  \:\                  \__\/        \  \:\       \__\::::/
 *         \__\/           ~~~~       \__\/                                \__\/           ~~~~
 *
 *
 * @ 名称: NVM_Flash.c
 * @ 描述:
 * @ 作者: Tomy
 * @ 日期: 2021年2月2日
 * @ 版本: V1.0
 * @ 历史: V1.0 2021年2月2日 Summary
 */
#include <stdio.h>
#include "flash.h"
#include "NVM_Flash.h"


tFlashDriverAPIInfo *g_pFlashDriverAPIRAM = NULL;
#define FLASH_DRV_OFFSET    (0x00010000)   //用于定位驱动函数起始地址段
#define CAL_OFFSET(funcPtr) ((uint32_t)(funcPtr) - FLASH_DRV_OFFSET)	//用于定位驱动函数的起始地址

#pragma GCC diagnostic ignored "-Wunused-const-variable="
__attribute__((used)) FLASH_DRIVER_SECTION_OFFSET static const tFlashDriverAPIInfo gs_FlashDriverAPI =
{
    (tpfFLASH_DRV_EraseSector)   CAL_OFFSET(EFM_EraseSector),
    (tpfFLASH_DRV_Program)       CAL_OFFSET(EFM_WriteFlash),
};

/* TODO S32K_FlashDrv: #04 Flash 驱动函数表：包含前16（0x10）字节的指针映射偏移表以及相应的4个驱动函数
 * 编译后，通过 J-Flash 打开 Hex 文件提取对应地址处的内容，粘贴到以下数组即可测试
 */
uint8_t g_flashDriverRAM[] =
{
    0x09,0x00,0x00,0x00,0x61,0x01,0x00,0x00,0x08,0xB5,0x01,0x46,0xC9,0x4A,0x12,0x68,0x52,0xB9,0x40,0xF2,0x23,0x12,0xC7,0x4B,0x1A,0x60,0x43,0xF2,0x10,0x22,0x1A,0x60,
    0x1A,0x46,0x12,0x68,0x02,0xB9,0x01,0x20,0x00,0xBF,0x00,0x22,0x00,0x92,0x06,0xE0,0x00,0x9A,0x53,0x1C,0x00,0x93,0xB2,0xF5,0x7A,0x7F,0x00,0xD1,0x03,0x20,0xBD,0x4A,
    0x10,0x32,0x12,0x68,0xC2,0xF3,0x00,0x22,0x00,0x2A,0xF1,0xD0,0xB9,0x4A,0x10,0x32,0x12,0x68,0xC2,0xF3,0x00,0x12,0x42,0xB1,0xB6,0x4A,0x14,0x32,0x12,0x68,0x22,0xF0,
    0x10,0x02,0x10,0x32,0xB3,0x4B,0x14,0x33,0x1A,0x60,0xB2,0x4A,0x10,0x32,0x12,0x68,0x02,0xF0,0x3F,0x02,0x0A,0xB1,0x01,0x22,0x00,0xE0,0x00,0x22,0x42,0xB1,0xAD,0x4A,
    0x14,0x32,0x12,0x68,0x42,0xF0,0x3F,0x02,0xAA,0x4B,0x14,0x33,0x1A,0x60,0x01,0x20,0x00,0x20,0x00,0xBF,0x4A,0x0B,0x04,0x23,0x03,0xEB,0x42,0x31,0x00,0x28,0x53,0xD1,
    0xA4,0x4A,0x0C,0x32,0x12,0x68,0x22,0xF0,0x01,0x02,0x52,0x1C,0xA1,0x4B,0x0C,0x33,0x1A,0x60,0x1A,0x46,0x12,0x68,0x22,0xF0,0x70,0x02,0x40,0x32,0x1A,0x60,0x42,0x1E,
    0x0A,0x60,0x00,0xBF,0x00,0x22,0x00,0x92,0x06,0xE0,0x00,0x9A,0x53,0x1C,0x00,0x93,0xB2,0xF5,0x7A,0x7F,0x00,0xD1,0x03,0x20,0x96,0x4A,0x10,0x32,0x12,0x68,0xC2,0xF3,
    0x00,0x22,0x00,0x2A,0xF1,0xD0,0x93,0x4A,0x10,0x32,0x12,0x68,0xC2,0xF3,0x00,0x12,0x42,0xB1,0x90,0x4A,0x14,0x32,0x12,0x68,0x22,0xF0,0x10,0x02,0x10,0x32,0x8D,0x4B,
    0x14,0x33,0x1A,0x60,0x8B,0x4A,0x10,0x32,0x12,0x68,0x02,0xF0,0x3F,0x02,0x0A,0xB1,0x01,0x22,0x00,0xE0,0x00,0x22,0x42,0xB1,0x86,0x4A,0x14,0x32,0x12,0x68,0x42,0xF0,
    0x3F,0x02,0x84,0x4B,0x14,0x33,0x1A,0x60,0x01,0x20,0x00,0x20,0x00,0xBF,0x81,0x4A,0x0C,0x32,0x12,0x68,0x22,0xF0,0x70,0x02,0x7E,0x4B,0x0C,0x33,0x1A,0x60,0x1A,0x46,
    0x12,0x68,0x22,0xF0,0x01,0x02,0x1A,0x60,0x7A,0x4A,0x12,0x68,0x01,0x2A,0x06,0xD1,0x00,0x22,0x78,0x4B,0x1A,0x60,0x1A,0x46,0x12,0x68,0x02,0xB9,0x01,0x20,0x08,0xBD,
    0x2D,0xE9,0xF8,0x47,0x04,0x46,0x8C,0x46,0x15,0x46,0xE1,0x46,0x23,0x46,0x04,0xF0,0x03,0x00,0x10,0xB1,0x01,0x20,0xBD,0xE8,0xF8,0x87,0xAE,0x08,0x05,0xF0,0x03,0x01,
    0x49,0xB1,0x59,0xF8,0x26,0x80,0x4F,0xEA,0xC1,0x0A,0x4F,0xF0,0xFF,0x30,0x00,0xFA,0x0A,0xF0,0x40,0xEA,0x08,0x08,0x67,0x48,0x00,0x68,0x68,0xB9,0x40,0xF2,0x23,0x10,
    0xDF,0xF8,0x90,0xA1,0xCA,0xF8,0x00,0x00,0x43,0xF2,0x10,0x20,0xCA,0xF8,0x00,0x00,0x50,0x46,0x00,0x68,0x00,0xB9,0x01,0x27,0x00,0xBF,0x00,0x20,0x00,0x90,0x08,0xE0,
    0x00,0x98,0x00,0xF1,0x01,0x0A,0xCD,0xF8,0x00,0xA0,0xB0,0xF5,0x7A,0x7F,0x00,0xD1,0x03,0x27,0x58,0x48,0x10,0x30,0x00,0x68,0xC0,0xF3,0x00,0x20,0x00,0x28,0xEF,0xD0,
    0x54,0x48,0x10,0x30,0x00,0x68,0xC0,0xF3,0x00,0x10,0x58,0xB1,0x51,0x48,0x14,0x30,0x00,0x68,0x20,0xF0,0x10,0x00,0x10,0x30,0xDF,0xF8,0x38,0xA1,0x0A,0xF1,0x14,0x0A,
    0xCA,0xF8,0x00,0x00,0x4B,0x48,0x10,0x30,0x00,0x68,0x00,0xF0,0x3F,0x00,0x08,0xB1,0x01,0x20,0x00,0xE0,0x00,0x20,0x58,0xB1,0x46,0x48,0x14,0x30,0x00,0x68,0x40,0xF0,
    0x3F,0x00,0xDF,0xF8,0x10,0xA1,0x0A,0xF1,0x14,0x0A,0xCA,0xF8,0x00,0x00,0x01,0x27,0x00,0x27,0x00,0xBF,0x0F,0xB1,0x38,0x46,0x9D,0xE7,0x3F,0x20,0xDF,0xF8,0xF4,0xA0,
    0x0A,0xF1,0x14,0x0A,0xCA,0xF8,0x00,0x00,0x3A,0x48,0x0C,0x30,0x00,0x68,0x20,0xF0,0x01,0x00,0x40,0x1C,0xDF,0xF8,0xDC,0xA0,0x0A,0xF1,0x0C,0x0A,0xCA,0xF8,0x00,0x00,
    0x50,0x46,0x00,0x68,0x20,0xF0,0x70,0x00,0x20,0x30,0xCA,0xF8,0x00,0x00,0x00,0x22,0x1F,0xE0,0x59,0xF8,0x22,0x00,0x18,0x60,0x00,0xBF,0x2E,0x48,0x10,0x30,0x00,0x68,
    0xC0,0xF3,0x00,0x20,0x00,0x28,0xF8,0xD0,0x2A,0x48,0x10,0x30,0x00,0x68,0xC0,0xF3,0xC0,0x00,0x08,0xB1,0x01,0x27,0x0E,0xE0,0x1B,0x1D,0x26,0x48,0x14,0x30,0x00,0x68,
    0x40,0xF0,0x10,0x00,0xDF,0xF8,0x8C,0xA0,0x0A,0xF1,0x14,0x0A,0xCA,0xF8,0x00,0x00,0x52,0x1C,0xB2,0x42,0xDD,0xD3,0x00,0xBF,0xD9,0xB1,0xC3,0xF8,0x00,0x80,0x00,0xBF,
    0x1C,0x48,0x10,0x30,0x00,0x68,0xC0,0xF3,0x00,0x20,0x00,0x28,0xF8,0xD0,0x19,0x48,0x10,0x30,0x00,0x68,0xC0,0xF3,0xC0,0x00,0x00,0xB1,0x01,0x27,0x15,0x48,0x14,0x30,
    0x00,0x68,0x40,0xF0,0x10,0x00,0xDF,0xF8,0x4C,0xA0,0x0A,0xF1,0x14,0x0A,0xCA,0xF8,0x00,0x00,0x10,0x48,0x0C,0x30,0x00,0x68,0x20,0xF0,0x70,0x00,0xDF,0xF8,0x34,0xA0,
    0x0A,0xF1,0x0C,0x0A,0xCA,0xF8,0x00,0x00,0x50,0x46,0x00,0x68,0x20,0xF0,0x01,0x00,0xCA,0xF8,0x00,0x00,0x07,0x48,0x00,0x68,0x01,0x28,0x08,0xD1,0x00,0x20,0xDF,0xF8,
    0x14,0xA0,0xCA,0xF8,0x00,0x00,0x50,0x46,0x00,0x68,0x00,0xB9,0x01,0x27,0x38,0x46,0x21,0xE7,0x00,0x00,0x00,0x04,0x01,0x40
};

#define BUFFER_SIZE 0x100u  /* Size of data source */
// #define EN_FLASH_DRIVER_DEBUG
/*******************************************************************************
* @name   : NVM_TestFlashDriver
* @brief  : 用于测试 Flash API
* @param  : void
* @retval : void
*******************************************************************************/
void NVM_TestFlashDriver(void)
{
    uint32_t destAddr = 20u * FEATURE_FLS_PF_BLOCK_SECTOR_SIZE; /* Erase the sixth PFlash sector */
    /* TODO S32K_FlashDrv: #05 注意不同MCU的Sector Size不同，需要进行相应调整，否则FLASH_DRV_EraseSector会执行失败 */
    uint32_t size = FEATURE_FLS_PF_BLOCK_SECTOR_SIZE;
    uint8_t sourceBuffer[BUFFER_SIZE];
    
    size = BUFFER_SIZE;
    for (uint32_t i = 0u; i < BUFFER_SIZE; i++)
    {
        sourceBuffer[i] = i;
    }

#ifdef EN_FLASH_DRIVER_DEBUG /* TODO S32K_FlashDrv: #06 This macro is in the header file: flash_driver.h */
    g_pFlashDriverAPIRAM = (tFlashDriverAPIInfo *)g_flashDriverRAM;
    g_pFlashDriverAPIRAM->pfFLASH_DRV_EraseSector      = EFM_EraseSector;
    g_pFlashDriverAPIRAM->pfFLASH_DRV_Program          = EFM_WriteFlash;
#else
    g_pFlashDriverAPIRAM = (tFlashDriverAPIInfo *)g_flashDriverRAM;
    g_pFlashDriverAPIRAM->pfFLASH_DRV_EraseSector      = (tpfFLASH_DRV_EraseSector)     ((uint32_t)g_flashDriverRAM + (uint32_t)(g_pFlashDriverAPIRAM->pfFLASH_DRV_EraseSector));
    g_pFlashDriverAPIRAM->pfFLASH_DRV_Program          = (tpfFLASH_DRV_Program)         ((uint32_t)g_flashDriverRAM + (uint32_t)(g_pFlashDriverAPIRAM->pfFLASH_DRV_Program));
#endif

    g_pFlashDriverAPIRAM->pfFLASH_DRV_EraseSector(destAddr);

    g_pFlashDriverAPIRAM->pfFLASH_DRV_Program(destAddr, sourceBuffer, size);
}

/* -------------------------------------------- END OF FILE -------------------------------------------- */
